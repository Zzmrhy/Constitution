<h2>Punishments List</h2>
<% if (punishments && punishments.length > 0) { %>
<ul style="list-style-type: none; padding: 0;">
    <% punishments.forEach(function(punishment) { %>
      <li style="margin-bottom: 15px; border: 1px solid #ccc; padding: 10px; border-radius: 5px; position: relative;">
        <strong>Punishment:</strong>
        <br />
        <small style="display: block; margin-top: 5px;">
          Min Violations: <%= punishment.min %>, Max Violations: <%= punishment.max === null ? 'No limit' : punishment.max %>
        </small>
        <span class="punishment-text" style="padding: 5px; margin-top: 5px; display: inline-block; width: 100%; white-space: normal;"><%= punishment.text || 'No punishment text set' %></span>
        
        <% if (isHeadAdmin) { %>
        <div style="margin-top: 8px;">
          <button class="edit-punishment-btn" data-id="<%= punishment.id %>" style="margin-right: 10px;">Edit</button>
          <button class="remove-punishment-btn" data-id="<%= punishment.id %>">Remove</button>
        </div>
        <% } %>
      </li>
    <% }); %>
  </ul>
<% } else { %>
  <h2>No punishments available</h2>
  <p>There are currently no punishments to display.</p>
<% } %>

<!-- Add Punishment Suggestions UI -->

<hr />
<section id="punishment-suggestions-section">
  <h2>Punishment Suggestions</h2>

  <% if (!isAdmin) { %>
  <div id="suggestion-form-container" style="margin-bottom: 20px;">
    <h3>Make a Suggestion</h3>
    <textarea id="suggestion-text" rows="3" placeholder="Enter your punishment suggestion here..." style="width: 100%; padding: 10px; font-size: 14px;"></textarea>
    <button id="submit-suggestion-btn" style="margin-top: 10px;">Submit Suggestion</button>
    <p id="suggestion-form-message" style="color: red; margin-top: 5px; display: none;"></p>
  </div>
  <% } else { %>
  <p>Admins cannot submit punishment suggestions.</p>
  <% } %>

  <div id="suggestions-list-container">
    <h3>Current Suggestions</h3>
    <ul id="suggestions-list" style="list-style-type: none; padding-left: 0;">
    </ul>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // User and role info passed from server-rendered data
    const user = <%= JSON.stringify(user || {}) %>;
    const isAdmin = <%= JSON.stringify(isAdmin || false) %>;
    const isSubAdmin = <%= JSON.stringify(isSubAdmin || false) %>;
    const isHeadAdmin = <%= JSON.stringify(isHeadAdmin || false) %>;

    // Function to handle edit button click
    function handleEditClick(btn) {
      const li = btn.closest('li');
      const punishmentTextSpan = li.querySelector('.punishment-text');
      const originalText = punishmentTextSpan.textContent;
      const id = btn.getAttribute('data-id');

      // Replace text with input
      const input = document.createElement('input');
      input.type = 'text';
      input.value = originalText;
      input.style.width = '100%';
      punishmentTextSpan.replaceWith(input);

      // Replace buttons with save/cancel
      const buttonDiv = btn.parentElement;
      buttonDiv.innerHTML = '<button class="save-edit-btn">Save</button> <button class="cancel-edit-btn">Cancel</button>';

      // Save button
      buttonDiv.querySelector('.save-edit-btn').addEventListener('click', async () => {
        const newText = input.value.trim();
        if (!newText) {
          alert('Punishment text cannot be empty');
          return;
        }
        try {
          const res = await fetch(`/api/head-admin/punishments/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ text: newText })
          });
          if (res.ok) {
            window.location.reload();
          } else {
            const err = await res.json();
            alert('Error updating punishment: ' + (err.error || 'Unknown error'));
          }
        } catch (err) {
          alert('Error updating punishment');
        }
      });

      // Cancel button
      buttonDiv.querySelector('.cancel-edit-btn').addEventListener('click', () => {
        input.replaceWith(punishmentTextSpan);
        buttonDiv.innerHTML = '<button class="edit-punishment-btn" data-id="' + id + '" style="margin-right: 10px;">Edit</button> <button class="remove-punishment-btn" data-id="' + id + '">Remove</button>';
        // Re-attach event listeners
        const newEditBtn = buttonDiv.querySelector('.edit-punishment-btn');
        const newRemoveBtn = buttonDiv.querySelector('.remove-punishment-btn');
        handleEditClick(newEditBtn);
        newRemoveBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to remove this punishment?')) {
            fetch(`/api/head-admin/punishments/${id}`, {
              method: 'DELETE',
              credentials: 'include'
            }).then(res => {
              if (res.ok) {
                window.location.reload();
              } else {
                res.json().then(err => alert('Error removing punishment: ' + (err.error || 'Unknown error')));
              }
            }).catch(err => alert('Error removing punishment'));
          }
        });
      });
    }

    // Attach edit handlers to all edit buttons
    document.querySelectorAll('.edit-punishment-btn').forEach(btn => {
      handleEditClick(btn);
    });

    // Handle remove punishment buttons
    document.querySelectorAll('.remove-punishment-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const id = this.getAttribute('data-id');
        if (confirm('Are you sure you want to remove this punishment?')) {
          fetch(`/api/head-admin/punishments/${id}`, {
            method: 'DELETE',
            credentials: 'include'
          }).then(res => {
            if (res.ok) {
              window.location.reload();
            } else {
              res.json().then(err => alert('Error removing punishment: ' + (err.error || 'Unknown error')));
            }
          }).catch(err => alert('Error removing punishment'));
        }
      });
    });

    const suggestionTextElem = document.getElementById('suggestion-text');
    const submitSuggestionBtn = document.getElementById('submit-suggestion-btn');
    const suggestionFormMessage = document.getElementById('suggestion-form-message');
    const suggestionsList = document.getElementById('suggestions-list');

    async function loadSuggestions() {
      try {
        const res = await fetch('/api/punishment-suggestions');
        if (!res.ok) throw new Error('Failed to load suggestions');
        const data = await res.json();
        renderSuggestions(data.suggestions || []);
      } catch (err) {
        suggestionsList.innerHTML = '<li>Error loading suggestions</li>';
      }
    }

    function renderSuggestions(suggestions) {
      suggestionsList.innerHTML = '';
      if (suggestions.length === 0) {
        suggestionsList.innerHTML = '<li>No suggestions available.</li>';
        return;
      }

      suggestions.forEach(suggestion => {
        const li = document.createElement('li');
        li.style.border = '1px solid #ddd';
        li.style.padding = '10px';
        li.style.marginBottom = '10px';
        li.style.borderRadius = '5px';

        const textP = document.createElement('p');
        textP.textContent = suggestion.text;
        li.appendChild(textP);

        const authorP = document.createElement('small');
        authorP.textContent = `Suggested by: ${suggestion.submittedBy}`;
        li.appendChild(authorP);

        const votesDiv = document.createElement('div');
        votesDiv.style.marginTop = '5px';
        votesDiv.textContent = `Approve: ${suggestion.votes.approve.length} | Reject: ${suggestion.votes.reject.length}`;
        li.appendChild(votesDiv);

        if (isAdmin || isSubAdmin) {
          const disableVote = isSubAdmin && suggestion.submittedBy === user.Email;

          const voteApproveBtn = document.createElement('button');
          voteApproveBtn.textContent = 'Approve';
          voteApproveBtn.disabled = disableVote;
          voteApproveBtn.style.marginRight = '5px';
          voteApproveBtn.addEventListener('click', () => voteSuggestion(suggestion.id, 'approve'));

          const voteRejectBtn = document.createElement('button');
          voteRejectBtn.textContent = 'Reject';
          voteRejectBtn.disabled = disableVote;
          voteRejectBtn.addEventListener('click', () => voteSuggestion(suggestion.id, 'reject'));

          const voteNotice = document.createElement('small');
          if (disableVote) {
            voteApproveBtn.title = 'You cannot vote on your own suggestion';
            voteRejectBtn.title = 'You cannot vote on your own suggestion';
            voteNotice.textContent = "You cannot vote on your own suggestion.";
            voteNotice.style.color = 'red';
            voteNotice.style.display = 'block';
            voteNotice.style.marginTop = '5px';
          }

          li.appendChild(voteApproveBtn);
          li.appendChild(voteRejectBtn);
          li.appendChild(voteNotice);
        }

        suggestionsList.appendChild(li);
      });
    }

    if (submitSuggestionBtn) {
      submitSuggestionBtn.addEventListener('click', async () => {
        const text = suggestionTextElem.value.trim();
        if (!text) {
          suggestionFormMessage.textContent = 'Suggestion cannot be empty.';
          suggestionFormMessage.style.color = 'red';
          suggestionFormMessage.style.display = 'block';
          return;
        }
        // Disable the submit button while submitting
        submitSuggestionBtn.disabled = true;
        suggestionFormMessage.style.display = 'none';

        try {
          const res = await fetch('/api/punishment-suggestions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ suggestion: text })
          });
          if (res.ok) {
            suggestionTextElem.value = '';
            suggestionFormMessage.style.color = 'green';
            suggestionFormMessage.textContent = 'Suggestion submitted successfully.';
            suggestionFormMessage.style.display = 'block';
            loadSuggestions();
          } else {
            const errData = await res.json();
            suggestionFormMessage.style.color = 'red';
            suggestionFormMessage.textContent = errData.error || 'Failed to submit suggestion.';
            suggestionFormMessage.style.display = 'block';
          }
        } catch (err) {
          suggestionFormMessage.style.color = 'red';
          suggestionFormMessage.textContent = 'Error submitting suggestion.';
          suggestionFormMessage.style.display = 'block';
        }
        // Re-enable the submit button after submission
        submitSuggestionBtn.disabled = false;
      });
    }

    async function voteSuggestion(id, vote) {
      // Voting buttons are not disabled since button references are unavailable; this can cause multiple clicks
      try {
        const res = await fetch(`/api/punishment-suggestions/${id}/vote`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ vote })
        });
        if (res.ok) {
          loadSuggestions();
        } else {
          const errData = await res.json();
          alert('Error voting: ' + (errData.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error voting on suggestion.');
      }
    }

    loadSuggestions();
  });
</script>
