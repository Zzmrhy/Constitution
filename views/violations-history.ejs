<div style="max-width: 800px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
    <h1 id="header3" style="text-align: center; color: #dc3545; margin-bottom: 30px;"><%= title %></h1>

    <!-- Punishment Display for Archived Totals -->
    <% if (history && history.length > 0) { %>
        <% const mostRecent = history[history.length - 1]; %>
        <% const totalBroken = mostRecent.violations.reduce((sum, v) => sum + v.brokenRules.length, 0); %>
        <% const currentPunishment = getCurrentPunishment(totalBroken); %>
        <% if (currentPunishment && currentPunishment.length > 0) { %>
            <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #856404; text-align: center;">Archived Period Punishment</h3>
                <p style="color: #856404; text-align: center; margin-bottom: 10px;">Total Violations: <%= totalBroken %></p>
                <p style="color: #856404; text-align: center;">Punishment(s): <%= currentPunishment.map(p => p.punishment || p.text).join(', ') %></p>
            </div>
        <% } %>
    <% } %>

    <!-- Previous Months Violations -->
    <div style="margin-bottom: 40px;">
        <h2 style="text-align: center; color: #495057;">Previous Months Violations</h2>
        <p style="text-align: center; color: #6c757d; font-size: 14px;">This graph shows total violations per week from archived history.</p>
        <canvas id="violationsChart" width="400" height="200"></canvas>

        <!-- Violations Details by Week -->
        <div id="weeklyViolationsDetails" style="margin-top: 20px; display: none;">
            <h3 style="color: #495057;">Violations Details</h3>
            <canvas id="weeklyViolationsChart" width="400" height="200" style="margin-bottom: 20px;"></canvas>
            <div id="weeklyViolationsList"></div>
        </div>
    </div>

    <!-- Previous Week Violations -->
    <div style="margin-bottom: 40px;">
        <h2 style="text-align: center; color: #495057;">Previous Week Violations</h2>
        <p style="text-align: center; color: #6c757d; font-size: 14px;">This graph displays violations for the previous week.</p>
        <canvas id="cumulativeChart" width="400" height="200"></canvas>
    </div>

    <!-- Filtered Violations Display -->
    <div id="filteredViolations" style="display: none; margin-bottom: 40px; border: 1px solid #dee2e6; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 id="filteredTitle" style="color: #495057;"></h3>
        <canvas id="filteredViolationsChart" width="400" height="200" style="margin-bottom: 20px;"></canvas>
        <div id="filteredList"></div>
    </div>

    <!-- Hidden Original Violations History -->
    <div id="originalHistory" style="display: none;">
        <% if (history && history.length > 0) { %>
                <% history.forEach((entry, index) => { %>
                    <div style="margin-bottom: 20px; border: 1px solid #dee2e6; padding: 15px; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="color: #495057;">Archived on <%= new Date(entry.archivedAt).toLocaleString() %></h3>
                        <% if (entry.periodStart) { %>
                            <p style="color: #6c757d;">Period: <%= new Date(entry.periodStart).toLocaleDateString() %> to <%= new Date(entry.archivedAt).toLocaleDateString() %></p>
                        <% } %>
                        <% if (entry.violations && entry.violations.length > 0) { %>
                            <ul id="list" style="list-style: none; padding: 0;">
                                <% entry.violations.forEach((violation) => { %>
                                    <li style="background-color: #f8d7da; margin-bottom: 10px; padding: 10px; border-radius: 5px; border-left: 4px solid #dc3545;">
                                        <strong style="color: #721c24;">Date:</strong> <%= violation.date %><br>
                                        <strong style="color: #721c24;">Broken Rules:</strong>
                                        <ul style="margin-top: 5px;">
                                            <% if (Array.isArray(violation.brokenRules)) { %>
                                                <% violation.brokenRules.forEach((rule) => { %>
                                                    <li style="color: #721c24;"><%= rule %></li>
                                                <% }); %>
                                            <% } else { %>
                                                <li style="color: #721c24;">No rules listed</li>
                                            <% } %>
                                        </ul>
                                    </li>
                                <% }); %>
                            </ul>
                        <% } else { %>
                            <p style="color: #6c757d;">No violations in this period.</p>
                        <% } %>
                </div>
            <% }); %>
        <% } else { %>
            <h1 style="text-align: center; color: #6c757d;">No violations history yet.</h1>
    <% } %>
    </div>
</div>

<!-- add Chart.js CDN so charts render reliably -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Pass server data to client-side JavaScript
    window.violationsHistoryData = <%- JSON.stringify(history || []) %>;
    window.ruleCountsData = <%- JSON.stringify(typeof ruleCounts !== 'undefined' ? ruleCounts : {}) %>;
    window.dateCountsData = <%- JSON.stringify(typeof dateCounts !== 'undefined' ? dateCounts : {}) %>;
    window.currentViolationsData = <%- JSON.stringify(currentViolations || []) %>;
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const history = window.violationsHistoryData || [];
    const currentViolations = window.currentViolationsData || [];

    let filteredChart = null;

    // Helper to normalize any date-like value to YYYY-MM-DD
    function normalizeDateToYMD(d) {
        try {
            const dt = new Date(d);
            if (isNaN(dt)) return String(d);
            return dt.toISOString().slice(0,10);
        } catch (e) {
            return String(d);
        }
    }

    // -------------------------
    // Sort archived history chronologically (oldest -> newest)
    // -------------------------
    const sortedHistory = history.slice().sort((a, b) => {
        const aTs = Number(a.archivedAt) || 0;
        const bTs = Number(b.archivedAt) || 0;
        return aTs - bTs;
    });

    // -------------------------
    // Build "Stored Violations Trend" from archived snapshots (entry.archivedAt)
    // Each label represents an archived snapshot and its number is the total violations stored in that snapshot.
    // -------------------------
    const archivedLabels = sortedHistory.map(entry => normalizeDateToYMD(entry.archivedAt));
    const archivedCounts = sortedHistory.map(entry =>
        (entry.violations || []).reduce((sum, v) => sum + (Array.isArray(v.brokenRules) ? v.brokenRules.length : 1), 0)
    );

    // -------------------------
    // Weekly aggregation (restore weekly/cumulative chart data)
    // -------------------------
    const weeklyData = {};
    sortedHistory.forEach(entry => {
        const weekLabel = new Date(entry.archivedAt).toLocaleDateString();
        const totalViolations = (entry.violations || []).reduce((sum, v) => sum + (Array.isArray(v.brokenRules) ? v.brokenRules.length : 1), 0);
        weeklyData[weekLabel] = (weeklyData[weekLabel] || 0) + totalViolations;
    });

    // Include currentViolations as "Current Week" snapshot (if desired)
    const currentWeekTotal = (currentViolations || []).reduce((sum, v) => sum + (Array.isArray(v.brokenRules) ? v.brokenRules.length : 1), 0);
    const currentWeekLabel = 'Current Week';
    if (currentWeekTotal > 0) {
        weeklyData[currentWeekLabel] = (weeklyData[currentWeekLabel] || 0) + currentWeekTotal;
    }

    const sortedWeeks = Object.keys(weeklyData).filter(w => w !== currentWeekLabel).sort((a,b) => new Date(a) - new Date(b));
    if (weeklyData[currentWeekLabel]) sortedWeeks.push(currentWeekLabel);
    const weeklyCounts = sortedWeeks.map(week => weeklyData[week]);

    // Cumulative data (if needed elsewhere)
    const cumulativeCounts = [];
    let cumulativeSum = 0;
    weeklyCounts.forEach(count => {
        cumulativeSum += count;
        cumulativeCounts.push(cumulativeSum);
    });

    // -------------------------
    // Total Rules Broken Chart
    // -------------------------
    const totalRulesChartCanvas = document.getElementById('totalRulesChart');
    if (totalRulesChartCanvas) {
        const ctx = totalRulesChartCanvas.getContext('2d');
        const totalRuleCounts = window.totalRuleCounts || {};

        const sortedRules = Object.keys(totalRuleCounts).sort((a, b) => totalRuleCounts[b] - totalRuleCounts[a]); // Sort by count descending
        const ruleCounts = sortedRules.map(rule => totalRuleCounts[rule]);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedRules,
                datasets: [{
                    label: 'Total Rules Broken',
                    data: ruleCounts,
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Total Rules Broken Across All History'
                    }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'Number of Times Broken' } },
                    x: { title: { display: true, text: 'Rule Classifications' } }
                }
            }
        });
    }

    // -------------------------
    // Previous Months Violations Chart
    // -------------------------
    const violationsChartCanvas = document.getElementById('violationsChart');
    if (violationsChartCanvas) {
        const ctx = violationsChartCanvas.getContext('2d');

        // Use all history except the most recent entry (previous months)
        const previousMonthsHistory = sortedHistory.slice(0, -1);

        // Aggregate violations by week (7-day intervals)
        const weeklyData = {};
        previousMonthsHistory.forEach(entry => {
            if (entry.violations) {
                entry.violations.forEach(v => {
                    const date = new Date(v.date);
                    // Get the start of the week (Monday)
                    const dayOfWeek = date.getDay();
                    const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // adjust when day is Sunday
                    const monday = new Date(date.setDate(diff));
                    const weekKey = monday.getFullYear() + '-' + String(monday.getMonth() + 1).padStart(2, '0') + '-' + String(monday.getDate()).padStart(2, '0');
                    const count = Array.isArray(v.brokenRules) ? v.brokenRules.length : 1;
                    weeklyData[weekKey] = (weeklyData[weekKey] || 0) + count;
                });
            }
        });

        const sortedWeeks = Object.keys(weeklyData).sort();
        const weeklyCounts = sortedWeeks.map(week => weeklyData[week]);

        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedWeeks,
                datasets: [{
                    label: 'Violations per Week',
                    data: weeklyCounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Previous Months Violations Trendline'
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                },
                onClick: function(evt, elements) {
                    if (elements && elements.length > 0) {
                        const index = elements[0].index;
                        const weekKey = sortedWeeks[index];
                        showViolationsForWeek(weekKey);
                    }
                }
            }
        });

        // Add view switch buttons
        const chartContainer = violationsChartCanvas.parentElement;
        const viewDiv = document.createElement('div');
        viewDiv.style.textAlign = 'center';
        viewDiv.style.marginTop = '10px';
        const graphBtn = document.createElement('button');
        graphBtn.textContent = 'Graph View';
        graphBtn.style.marginRight = '10px';
        graphBtn.style.padding = '5px 10px';
        graphBtn.style.backgroundColor = '#6c757d';
        graphBtn.style.color = 'white';
        graphBtn.style.border = 'none';
        graphBtn.style.borderRadius = '3px';
        graphBtn.style.cursor = 'pointer';
        const trendlineBtn = document.createElement('button');
        trendlineBtn.textContent = 'Trendline View';
        trendlineBtn.style.padding = '5px 10px';
        trendlineBtn.style.backgroundColor = '#007bff';
        trendlineBtn.style.color = 'white';
        trendlineBtn.style.border = 'none';
        trendlineBtn.style.borderRadius = '3px';
        trendlineBtn.style.cursor = 'pointer';
        viewDiv.appendChild(graphBtn);
        viewDiv.appendChild(trendlineBtn);
        chartContainer.appendChild(viewDiv);

        graphBtn.addEventListener('click', function() {
            chart.config.type = 'bar';
            chart.options.plugins.title.text = 'Previous Months Violations';
            chart.update();
            graphBtn.style.backgroundColor = '#007bff';
            trendlineBtn.style.backgroundColor = '#6c757d';
        });

        trendlineBtn.addEventListener('click', function() {
            chart.config.type = 'line';
            chart.options.plugins.title.text = 'Previous Months Violations Trendline';
            chart.update();
            trendlineBtn.style.backgroundColor = '#007bff';
            graphBtn.style.backgroundColor = '#6c757d';
        });
    }

    // -------------------------
    // Previous Week Violations Chart
    // -------------------------
    const cumulativeChartCanvas = document.getElementById('cumulativeChart');
    if (cumulativeChartCanvas) {
        const ctx = cumulativeChartCanvas.getContext('2d');

        // Use the most recent archived entry for previous week
        const mostRecentEntry = sortedHistory[sortedHistory.length - 1];
        const prevDailyData = {};

        if (mostRecentEntry && mostRecentEntry.violations) {
            mostRecentEntry.violations.forEach(v => {
                const dateKey = normalizeDateToYMD(v.date);
                prevDailyData[dateKey] = (prevDailyData[dateKey] || 0) + (Array.isArray(v.brokenRules) ? v.brokenRules.length : 1);
            });
        }

        const prevSortedDates = Object.keys(prevDailyData).sort();
        const prevDailyCounts = prevSortedDates.map(date => prevDailyData[date]);

        let chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: prevSortedDates,
                datasets: [{
                    label: 'Daily Violations',
                    data: prevDailyCounts,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Previous Week Daily Violations Trendline'
                    }
                },
                scales: {
                    y: { beginAtZero: true }
                },
                onClick: function(evt, elements) {
                    if (elements && elements.length > 0) {
                        const index = elements[0].index;
                        const dateKey = prevSortedDates[index];
                        showPrevViolationsForDate(dateKey);
                    }
                }
            }
        });

        // Show violations for a specific week
        function showViolationsForWeek(weekKey) {
            const weeklyViolationsDetails = document.getElementById('weeklyViolationsDetails');
            const weeklyViolationsList = document.getElementById('weeklyViolationsList');
            const filteredViolationsDiv = document.getElementById('filteredViolations');

            weeklyViolationsList.innerHTML = '';

            const violationsForWeek = [];
            sortedHistory.forEach(entry => {
                if (entry.violations) {
                    entry.violations.forEach(v => {
                        const date = new Date(v.date);
                        // Get the start of the week (Monday)
                        const dayOfWeek = date.getDay();
                        const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // adjust when day is Sunday
                        const monday = new Date(date.setDate(diff));
                        const violationWeekKey = monday.getFullYear() + '-' + String(monday.getMonth() + 1).padStart(2, '0') + '-' + String(monday.getDate()).padStart(2, '0');
                        if (violationWeekKey === weekKey) {
                            violationsForWeek.push(v);
                        }
                    });
                }
            });

            if (!violationsForWeek.length) {
                weeklyViolationsList.innerHTML = '<p style="color: #6c757d;">No violations for this week.</p>';
                weeklyViolationsDetails.style.display = 'block';
                return;
            }

            // Group violations by date
            const violationsByDate = {};
            violationsForWeek.forEach(violation => {
                const dateKey = normalizeDateToYMD(violation.date);
                if (!violationsByDate[dateKey]) {
                    violationsByDate[dateKey] = [];
                }
                violationsByDate[dateKey].push(violation);
            });

            // Create daily chart for the week
            const sortedDates = Object.keys(violationsByDate).sort();
            const dailyCounts = sortedDates.map(date => violationsByDate[date].length);

            const weeklyViolationsChartCanvas = document.getElementById('weeklyViolationsChart');
            if (weeklyViolationsChartCanvas) {
                const ctx = weeklyViolationsChartCanvas.getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedDates,
                        datasets: [{
                            label: 'Violations per Day',
                            data: dailyCounts,
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Violations for Week Starting ${weekKey}`
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            Object.keys(violationsByDate).sort().forEach(dateKey => {
                const violations = violationsByDate[dateKey];
                const dateDiv = document.createElement('div');
                dateDiv.style.marginBottom = '20px';
                dateDiv.style.padding = '10px';
                dateDiv.style.backgroundColor = '#f8f9fa';
                dateDiv.style.borderRadius = '5px';
                dateDiv.style.border = '1px solid #dee2e6';

                dateDiv.innerHTML = `<h4 style="color: #495057; margin-bottom: 10px;">Date: ${dateKey} - Total Violations: ${violations.length}</h4>`;

                violations.forEach(violation => {
                    const violationDiv = document.createElement('div');
                    violationDiv.style.backgroundColor = '#fff';
                    violationDiv.style.marginBottom = '10px';
                    violationDiv.style.padding = '10px';
                    violationDiv.style.borderRadius = '5px';
                    violationDiv.style.borderLeft = '4px solid #dc3545';

                    let violationContent = `<strong style="color: #721c24;">Text:</strong> <span style="color: #000; font-weight: bold;">${violation.text || 'No text provided'}</span><br>`;
                    violationContent += `<strong style="color: #721c24;">Classification:</strong>`;
                    if (Array.isArray(violation.brokenRules) && violation.brokenRules.length > 0) {
                        violationContent += '<ul style="margin-top: 5px;">';
                        violation.brokenRules.forEach(rule => {
                            violationContent += `<li style="color: #721c24;">${rule}</li>`;
                        });
                        violationContent += '</ul>';
                    } else {
                        violationContent += ' <span style="color: #721c24;">No rules listed</span>';
                    }

                    violationDiv.innerHTML = violationContent;
                    dateDiv.appendChild(violationDiv);
                });

                weeklyViolationsList.appendChild(dateDiv);
            });

            weeklyViolationsDetails.style.display = 'block';
        }

        // Show violations for a specific date in previous week
        function showPrevViolationsForDate(dateKey) {
            const filteredViolationsDiv = document.getElementById('filteredViolations');
            const filteredTitle = document.getElementById('filteredTitle');
            const filteredList = document.getElementById('filteredList');

            filteredViolationsDiv.style.display = 'block';
            filteredTitle.textContent = `Violations on ${dateKey} (Previous Week)`;
            filteredList.innerHTML = '';

            const violationsForDate = [];
            sortedHistory.forEach(entry => {
                if (entry.violations) {
                    entry.violations.forEach(v => {
                        if (normalizeDateToYMD(v.date) === dateKey) {
                            violationsForDate.push(v);
                        }
                    });
                }
            });

            if (!violationsForDate.length) {
                filteredList.innerHTML = '<p style="color: #6c757d;">No violations for this date.</p>';
                filteredViolationsDiv.style.display = 'block';
                return;
            }

            // Create chart for violations by rule
            const ruleCounts = {};
            violationsForDate.forEach(violation => {
                if (Array.isArray(violation.brokenRules)) {
                    violation.brokenRules.forEach(rule => {
                        ruleCounts[rule] = (ruleCounts[rule] || 0) + 1;
                    });
                } else {
                    ruleCounts['No rules listed'] = (ruleCounts['No rules listed'] || 0) + 1;
                }
            });

            const sortedRules = Object.keys(ruleCounts).sort();
            const ruleViolationCounts = sortedRules.map(rule => ruleCounts[rule]);

            const filteredViolationsChartCanvas = document.getElementById('filteredViolationsChart');
            if (filteredViolationsChartCanvas) {
                const parent = filteredViolationsChartCanvas.parentElement;
                const newCanvas = document.createElement('canvas');
                newCanvas.id = 'filteredViolationsChart';
                newCanvas.width = 400;
                newCanvas.height = 200;
                newCanvas.style.marginBottom = '20px';
                parent.replaceChild(newCanvas, filteredViolationsChartCanvas);
                const ctx = newCanvas.getContext('2d');
                filteredChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedRules,
                        datasets: [{
                            label: 'Violations per Rule',
                            data: ruleViolationCounts,
                            backgroundColor: 'rgba(255, 159, 64, 0.2)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `Violations by Rule on ${dateKey}`
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            violationsForDate.forEach(violation => {
                const li = document.createElement('li');
                li.style.backgroundColor = '#f8d7da';
                li.style.marginBottom = '10px';
                li.style.padding = '10px';
                li.style.borderRadius = '5px';
                li.style.borderLeft = '4px solid #dc3545';
                li.innerHTML = `
                    <strong style="color: #721c24;">Text:</strong> <span style="color: #000;">${violation.text || 'No text provided'}</span><br>
                    <strong style="color: #721c24;">Classification:</strong>
                    <ul style="margin-top: 5px;">
                        ${Array.isArray(violation.brokenRules) ? violation.brokenRules.map(rule => `<li style="color: #721c24;">${rule}</li>`).join('') : '<li style="color: #721c24;">No rules listed</li>'}
                    </ul>
                `;
                filteredList.appendChild(li);
            });

            filteredViolationsDiv.style.display = 'block';
        }

        // Add view switch buttons
        const chartContainer = cumulativeChartCanvas.parentElement;
        const viewDiv = document.createElement('div');
        viewDiv.style.textAlign = 'center';
        viewDiv.style.marginTop = '10px';
        const graphBtn = document.createElement('button');
        graphBtn.textContent = 'Graph View';
        graphBtn.style.marginRight = '10px';
        graphBtn.style.padding = '5px 10px';
        graphBtn.style.backgroundColor = '#6c757d';
        graphBtn.style.color = 'white';
        graphBtn.style.border = 'none';
        graphBtn.style.borderRadius = '3px';
        graphBtn.style.cursor = 'pointer';
        const trendlineBtn = document.createElement('button');
        trendlineBtn.textContent = 'Trendline View';
        trendlineBtn.style.padding = '5px 10px';
        trendlineBtn.style.backgroundColor = '#007bff';
        trendlineBtn.style.color = 'white';
        trendlineBtn.style.border = 'none';
        trendlineBtn.style.borderRadius = '3px';
        trendlineBtn.style.cursor = 'pointer';
        viewDiv.appendChild(graphBtn);
        viewDiv.appendChild(trendlineBtn);
        chartContainer.appendChild(viewDiv);

        graphBtn.addEventListener('click', function() {
            chart.config.type = 'bar';
            chart.options.plugins.title.text = 'Previous Month Daily Violations';
            chart.update();
            graphBtn.style.backgroundColor = '#007bff';
            trendlineBtn.style.backgroundColor = '#6c757d';
        });

        trendlineBtn.addEventListener('click', function() {
            chart.config.type = 'line';
            chart.options.plugins.title.text = 'Previous Month Daily Violations Trendline';
            chart.update();
            trendlineBtn.style.backgroundColor = '#007bff';
            graphBtn.style.backgroundColor = '#6c757d';
        });
    }
});
</script>